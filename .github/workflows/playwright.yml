# Playwright E2E tests on every push and PR.
# On failure: uploads traces + report; for PRs, comments with artifacts and optional AI fix.
# To enable AI failure analysis: add GEMINI_API_KEY to repo secrets.
name: Playwright E2E

on:
  push: {}
  pull_request: {}

jobs:
  playwright:
    name: Playwright
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install backend dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: web-app/package-lock.json

      - name: Install frontend dependencies
        run: cd web-app && npm ci

      - name: Run unit tests
        run: cd web-app && npm run test:unit

      - name: Install Playwright browsers
        run: cd web-app && npx playwright install chromium --with-deps

      - name: Start backend
        run: |
          cd backend && uvicorn main:app --host 0.0.0.0 --port 8000 &
          sleep 5
          curl -sf http://localhost:8000/api/coatings || true

      - name: Run E2E tests
        run: cd web-app && npx playwright test
        env:
          CI: true

      - name: Upload test results JSON
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: test-results-json
          path: web-app/test-results.json
          retention-days: 1

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-report
          path: web-app/playwright-report/
          retention-days: 14

      - name: Upload Playwright traces
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-traces
          path: web-app/test-results/
          retention-days: 14

  failure-analyzer:
    name: AI Failure Analyzer
    runs-on: ubuntu-latest
    needs: playwright
    if: failure() && github.event_name == 'pull_request'
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download traces
        uses: actions/download-artifact@v4
        with:
          name: playwright-traces

      - name: Download report
        uses: actions/download-artifact@v4
        with:
          name: playwright-report

      - name: Download test results JSON
        uses: actions/download-artifact@v4
        with:
          name: test-results-json

      - name: Run AI failure analyzer
        id: ai
        continue-on-error: true
        run: |
          RESULTS=$(find . -name "test-results.json" -type f | head -1)
          [ -n "$RESULTS" ] && node scripts/analyze-playwright-failure.mjs "$RESULTS" || true
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            let failureSummary = 'Playwright E2E tests failed. ';
            try {
              const reportPath = path.join(process.cwd(), 'playwright-report', 'index.html');
              if (fs.existsSync(reportPath)) {
                failureSummary += 'Open the **playwright-report** artifact and view `index.html` in a browser for the full HTML report. ';
              }
            } catch (e) {}

            let traceInfo = '';
            try {
              const tracesDir = path.join(process.cwd(), 'playwright-traces');
              if (fs.existsSync(tracesDir)) {
                const walk = (dir) => {
                  let files = [];
                  const entries = fs.readdirSync(dir, { withFileTypes: true });
                  for (const e of entries) {
                    const full = path.join(dir, e.name);
                    if (e.isDirectory()) files = files.concat(walk(full));
                    else if (e.name.endsWith('.zip')) files.push(path.relative(process.cwd(), full));
                  }
                  return files;
                };
                const zips = walk(tracesDir);
                if (zips.length > 0) {
                  traceInfo = '\n\n**Trace files** (download `playwright-traces` artifact, then run `npx playwright show-trace <path-to-trace.zip>` locally or open in Cursor):\n- ' + zips.slice(0, 5).join('\n- ');
                }
              }
            } catch (e) {}

            let aiFix = '';
            try {
              const aiPath = path.join(process.cwd(), 'ai-fix-suggestion.md');
              if (fs.existsSync(aiPath)) {
                aiFix = '\n\n---\n\n## AI Suggested Fix\n\n' + fs.readFileSync(aiPath, 'utf8');
              }
            } catch (e) {}

            const body = `## Playwright E2E Failure

            ${failureSummary}

            **Artifacts:**
            - \`playwright-report\` — HTML report (open index.html in browser)
            - \`playwright-traces\` — Trace files for debugging in Cursor
            ${traceInfo}

            **Debug in Cursor:** Download the \`playwright-traces\` artifact, extract it, then run:
            \`\`\`bash
            npx playwright show-trace <path-to-trace.zip>
            \`\`\`
            ${aiFix}
            `;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });
